name: pulumi
on:
  push:
    branches:
      - production
      - staging
      - main
jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      all_modified_files: ${{ steps.detect.outputs.all_modified_files }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
          submodules: recursive
          token: ${{ secrets.FINE_GRAINED_PAT }}
      - id: detect
        uses: ./.github/actions/detect-changes

  stack:
    runs-on: ubuntu-latest
    outputs:
      stack: ${{ steps.stack.outputs.stack }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
          token: ${{ secrets.FINE_GRAINED_PAT }}
      - id: stack
        uses: ./.github/actions/set-pulumi-stack
        with:
          key: ${{ github.ref }}
          default-stack: development

  pulumi-up:
    needs: [changes, stack]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: [foundation, services, api, sites]
        include:
          - app: foundation
            workdir: ./infra/foundation
          - app: services
            workdir: ./infra/services
          - app: api
            workdir: ./infra/apps/api
          - app: sites
            workdir: ./infra/apps/sites
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_REGION: us-west-2
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      DOCKER_BUILDKIT: 1
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
          submodules: recursive
          token: ${{ secrets.FINE_GRAINED_PAT }}
      - id: gate
        shell: bash
        env:
          ALL_MODIFIED_FILES: ${{ needs.changes.outputs.all_modified_files }}
        run: |
          RUN=false
          case "${{ matrix.app }}" in
            foundation)
              [[ "$ALL_MODIFIED_FILES" == *"infra/foundation/"* ]] && RUN=true
              ;;
            services)
              [[ "$ALL_MODIFIED_FILES" == *"infra/services/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"node.base.Dockerfile"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/db/migrations/committed/"* ]] && RUN=true
              ;;
            api)
              [[ "$ALL_MODIFIED_FILES" == *"infra/apps/api/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/api/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/worker/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/db/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"api.Dockerfile"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"worker.Dockerfile"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"migrate.Dockerfile"* ]] && RUN=true
              ;;
            sites)
              [[ "$ALL_MODIFIED_FILES" == *"infra/apps/sites/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/maps/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/pro/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/lib/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/components-lib/"* ]] && RUN=true
              ;;
          esac

          echo "run=${RUN}" >> $GITHUB_OUTPUT

      - uses: ./.github/actions/free-disk-space
        if: steps.gate.outputs.run == 'true' && (matrix.app == 'api' || matrix.app == 'sites')
      - uses: ./.github/actions/setup-node-yarn
        if: steps.gate.outputs.run == 'true'
        with:
          node-version: 20
      - uses: ./.github/actions/aws-profile
        if: steps.gate.outputs.run == 'true'
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          region: us-west-2
      - uses: ./.github/actions/aws-configure
        if: steps.gate.outputs.run == 'true'
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      - name: Login to Amazon ECR
        if: steps.gate.outputs.run == 'true' && matrix.app == 'api'
        uses: ./.github/actions/aws-ecr-login
      - id: pulumi
        if: steps.gate.outputs.run == 'true'
        uses: ./.github/actions/pulumi-up
        with:
          stack-name: Probable-Futures/${{ matrix.app }}/${{ needs.stack.outputs.stack }}
          work-dir: ${{ matrix.workdir }}
      - name: Run migration task on Amazon ECS
        if: steps.gate.outputs.run == 'true' && matrix.app == 'services' && contains(needs.changes.outputs.all_modified_files, 'packages/db/migrations/committed/')
        # FIXME: `assignPublicIp=ENABLED` is a security risk. We do not want our server running migrations exposed to the public internet
        run: |
          DATE=$(date +'%Y-%m-%dT%H-%M-%S')
          aws rds create-db-cluster-snapshot \
            --db-cluster-identifier ${{ needs.stack.outputs.stack }}-pf-core-db-cluster \
            --db-cluster-snapshot-identifier ${{ needs.stack.outputs.stack }}-pf-core-db-cluster-${DATE}

          API_TASK_DEFINITION_ARN=$(pulumi stack output migrateTaskDefinitionArn --stack "Probable-Futures/api/${{ needs.stack.outputs.stack }}")
          MIGRATE_CLUSTER_NAME=$(pulumi stack output migrateClusterName --stack "Probable-Futures/services/${{ needs.stack.outputs.stack }}")
          MIGRATE_CLUSTER_SUBNET_IDS=$(pulumi stack output migrateClusterSubnetIds --stack "Probable-Futures/services/${{ needs.stack.outputs.stack }}")
          MIGRATE_CLUSTER_SECURITY_GROUPS=$(pulumi stack output migrateClusterSecurityGroups --stack "Probable-Futures/services/${{ needs.stack.outputs.stack }}")

          aws ecs run-task \
            --cluster ${MIGRATE_CLUSTER_NAME} \
            --task-definition ${API_TASK_DEFINITION_ARN} \
            --network-configuration "awsvpcConfiguration={subnets=${MIGRATE_CLUSTER_SUBNET_IDS},securityGroups=${MIGRATE_CLUSTER_SECURITY_GROUPS},assignPublicIp=ENABLED}" \
            --count 1 \
            --launch-type FARGATE \
            --started-by ci

  build-ui:
    needs: [changes]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [maps, pro]
        include:
          - target: maps
            workspace: "@probable-futures/maps"
            script: build
            artifact: maps-build
            artifact-path: packages/maps/build
          - target: pro
            workspace: "@probable-futures/pro"
            script: build
            artifact: pro-build
            artifact-path: packages/pro/build
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
          submodules: recursive
          token: ${{ secrets.FINE_GRAINED_PAT }}
      - id: gate
        shell: bash
        env:
          ALL_MODIFIED_FILES: ${{ needs.changes.outputs.all_modified_files }}
        run: |
          RUN=false
          case "${{ matrix.target }}" in
            maps)
              [[ "$ALL_MODIFIED_FILES" == *"packages/maps/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/lib/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/components-lib/"* ]] && RUN=true
              ;;
            pro)
              [[ "$ALL_MODIFIED_FILES" == *"packages/pro/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/lib/"* ]] && RUN=true
              [[ "$ALL_MODIFIED_FILES" == *"packages/components-lib/"* ]] && RUN=true
              ;;
          esac

          echo "run=${RUN}" >> $GITHUB_OUTPUT

      - uses: ./.github/actions/free-disk-space
        if: steps.gate.outputs.run == 'true'
      - uses: ./.github/actions/setup-node-yarn
        if: steps.gate.outputs.run == 'true'
        with:
          node-version: 20
      - uses: ./.github/actions/yarn-workspace-run
        if: steps.gate.outputs.run == 'true'
        with:
          workspace: ${{ matrix.workspace }}
          script: ${{ matrix.script }}
      - name: Upload build artifact
        if: steps.gate.outputs.run == 'true' && (matrix.target == 'maps' || matrix.target == 'pro')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact-path }}

  sentry-release:
    needs: [changes, build-ui, stack]
    runs-on: ubuntu-latest
    if: |
      contains(needs.changes.outputs.all_modified_files, 'packages/maps/') ||
      contains(needs.changes.outputs.all_modified_files, 'packages/pro/') ||
      contains(needs.changes.outputs.all_modified_files, 'packages/lib/') ||
      contains(needs.changes.outputs.all_modified_files, 'packages/components-lib/') ||
      contains(needs.changes.outputs.all_modified_files, 'packages/maps/src/stories')
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
          submodules: recursive
          token: ${{ secrets.FINE_GRAINED_PAT }}
      - name: Download maps build
        if: |
          contains(needs.changes.outputs.all_modified_files, 'packages/maps/') ||
          contains(needs.changes.outputs.all_modified_files, 'packages/lib/') ||
          contains(needs.changes.outputs.all_modified_files, 'packages/components-lib/')
        uses: actions/download-artifact@v4
        with:
          name: maps-build
          path: packages/maps/build
      - name: Download pro build
        if: |
          contains(needs.changes.outputs.all_modified_files, 'packages/pro/') ||
          contains(needs.changes.outputs.all_modified_files, 'packages/lib/') ||
          contains(needs.changes.outputs.all_modified_files, 'packages/components-lib/')
        uses: actions/download-artifact@v4
        with:
          name: pro-build
          path: packages/pro/build
      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
        with:
          environment: ${{ needs.stack.outputs.stack }}
          projects: "maps pro"
          sourcemaps: "packages/maps/build packages/pro/build"
